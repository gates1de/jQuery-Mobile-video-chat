<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>jQuery Mobile</title>
<link rel="stylesheet"
  href="//code.jquery.com/mobile/1.4.0/jquery.mobile-1.4.0.min.css" />
<script src="//code.jquery.com/jquery-1.10.2.min.js"></script>
<script src="//code.jquery.com/mobile/1.4.0/jquery.mobile-1.4.0.min.js">
</script>
</head>
<body>

<!--ページ領域-->
<div data-role="page" data-title="jQuery Mobile Video Chat">

  <!--ヘッダー領域-->
  <div data-role="header">
    <h1>jQuery Mobile Video Chat</h1>
  </div>

  <div role="main" class="ui-content">
		<div data-role="controlgroup" data-type="horizontal" data-inline="true" data-mini="true">
			<button class="ui-btn" id="video_on" onclick="startVideo();">Video ON</button>
			<button class="ui-btn" id="video_off" onclick="stopVideo();">Video OFF</button>
		  <button class="ui-btn" id="connect" onclick="call();">Connect</button>
		  <button class="ui-btn" id="exit" onclick="exit();">Exit</button>
		</div>  
		<br />
		<div data-role="content" data-type="horizontal" data-inline="true" id="all_video">
		</div>
	</div>
  <div data-role="footer">
    <h3>Copyright 2014-201X, Yyy.Xxxxx</h3>
  </div>

</div>
<script src="/socket.io/socket.io.js"></script>
<style>
.ui-bar-a {
border: 1px solid #456f9a;
background: #5e87b0;
color: #fff;
font-weight: bold;
text-shadow: 0 -1px 1px #254f7a;
background-image: -moz-linear-gradient(top,#81a8ce,#5e87b0);
background-image: -webkit-gradient(linear,left top,left bottom,color-stop(0,#81a8ce),color-stop(1,#5e87b0));
width:400px;
}
</style>
<script>
  var localVideo = null;
  var localStream = null;
  var peerConnection = null;
  var peerStarted = false;
  var mediaConstraints = {'mandatory': {'OfferToReceiveAudio':false , 'OfferToReceiveVideo':true }};
  navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
	 
	// ---- multi people video & audio ----
	var remote_video_num = 1;
	var removed_video_num = 0;
  var videoElementsInUse = {};
  var videoElementsStandBy = {};

	window.onload = function() {	
		startVideo();
		setTimeout("call()", 1000);
	}	
 
  function getVideoForRemote(index) {
    var elementID = 'remote_video' + index;
    var element = document.getElementById(elementID);
    return element;
  }
 
  // ---- video element management ---
  function pushVideoStandBy(element) {
    videoElementsStandBy[element.id] = element;
		console.log('element.id = ' + element.id);
  }
 
  function popVideoStandBy() {
    var element = null;
    for (var id in videoElementsStandBy) {
      element = videoElementsStandBy[id];
      delete videoElementsStandBy[id];
      return element;
    }
    return null;
  }
 
  function pushVideoInUse(id, element) {
    videoElementsInUse[id] = element;
  }
 
  function popVideoInUse(id) {
    element = videoElementsInUse[id];
    delete videoElementsInUse[id];
    return element;
  }
 
  function attachVideo(id, stream) {
		addVideoTag(remoteUserName);	
    console.log('try to attach video. id=' + id);
    var videoElement = popVideoStandBy();
    if (videoElement) {
      videoElement.src = window.URL.createObjectURL(stream);
      console.log("videoElement.src=" + videoElement.src);
      pushVideoInUse(id, videoElement);
			$("video:hidden:first").fadeIn("1500");
		}
    else {
      console.error('--- no video element stand by.');
    }
  }
 
  function detachVideo(id) {
    console.log('try to detach video. id=' + id);
    var videoElement = popVideoInUse(id);
    if (videoElement) {
			// $("#" + videoElement.id).fadeOut("1500");
      videoElement.pause();
      videoElement.src = "";
      console.log("videoElement.src=" + videoElement.src);
      //pushVideoStandBy(videoElement);
    	removeVideoTag(videoElement.id);
		}
    else {
      console.warn('warning --- no video element using with id=' + id);
    }
  }
 
  function detachAllVideo() {
    var element = null;
    for (var id in videoElementsInUse) {
      detachVideo(id);
    }
  }
 
  function getFirstVideoInUse() {
    var element = null;
    for (var id in videoElementsInUse) {
      element = videoElementsInUse[id];
      return element;
    }
    return null;
  }
 
  function getVideoCountInUse() {
    var count = 0;
    for (var id in videoElementsInUse) {
      count++;
    }
    return count;
  }
  
  
  function isLocalStreamStarted() {
    if (localStream) {
      return true;
    }
    else {
      return false;
    }
  }

  // -------------- multi connections --------------------
  var MAX_CONNECTION_COUNT = 5;
  var connections = {}; // Connection hash
  function Connection() { // Connection Class
    var self = this;
    var id = "";  // socket.id of partner
    var peerconnection = null; // RTCPeerConnection instance
    var established = false; // is Already Established
    var iceReady = false;
  }
 
  function getConnection(id) {
    var con = null;
    con = connections[id];
    return con;
  }
 
  function addConnection(id, connection) {
    connections[id] = connection;
  }
 
  function getConnectionCount() {
    var count = 0;
    for (var id in connections) {
      count++;
    }
 
    console.log('getConnectionCount=' + count);
    return count;
  }
 
  function isConnectPossible() {
    if (getConnectionCount() < MAX_CONNECTION_COUNT) {
      console.log("isConnectPossible is true.");
			return true;
		}
    else {
			console.log("isConnectPossible is false.");
      return false;
  	}
	}
 
  function getConnectionIndex(id_to_lookup) {
    var index = 0;
    for (var id in connections) {
      if (id == id_to_lookup) {
        console.log('index = ' + index);
				return index;
      }
 
      index++;
    }
 
    // not found
    return -1;
  }
 
  function deleteConnection(id) {
    delete connections[id];
  }
 
  function stopAllConnections() {
    for (var id in connections) {
      var conn = connections[id];
      conn.peerconnection.close();
      conn.peerconnection = null;
      delete connections[id];
    }
  }
 
  function stopConnection(id) {
    var conn = connections[id];
    if(conn) {
      console.log('stop and delete connection with id=' + id);
      conn.peerconnection.close();
      conn.peerconnection = null;
      delete connections[id];
    }
    else {
      console.log('try to stop connection, but not found id=' + id);
    }
  }
 
  function isPeerStarted() {
    if (getConnectionCount() > 0) {
      return true;
    }
    else {
      return false;
    }
  }
 
	function addVideoTag(user_name) {
		var num = remote_video_num + removed_video_num;
		console.log("remote user name = " + user_name);
		$('#all_video').append('<div class="ui-grid-c"><div class="ui-block-a" id="user_name_remote_video' + num + '"><div class="ui-bar ui-bar-a"><center><video id="remote_video' + num + '" autoplay style="width: 400px; height: 320px; display:none;"></video>' + user_name  + '</center></div></div></div>'); 
		pushVideoStandBy(getVideoForRemote(num));
		remote_video_num++;
	}

	function removeVideoTag(video_id) {
		console.log("remove " + video_id);
		$('#' + video_id).remove();
		$('#user_name_' + video_id).remove();
		remote_video_num--;
		removed_video_num++;
	}

  // ---- socket ------
  // create socket
  var socketReady = false;
  var socket = io.connect('/');
  var roomName;
	var userName = getUserName();
	var remoteUserName;
	var socketId;
	var remoteSocketId;
  // socket: channel connected
  socket.on('connect', onOpened)
        .on('message', onMessage);

	socket.on('disconnected', onClosed);

  function onOpened(event) {
    console.log('socket opened.');
    socketReady = true;
    
		roomName = getRoomName(); // 会議室名を取得する
    socket.emit('enter', roomName);
		socket.on('enter', function(data) {
			console.log("your socket.id = " + data);
			socketId = data;
		});

		socket.emit('setUserName', getUserName());
		socket.on('setUserName', function(data) {
			console.log("your user_name is " + data);
		});
    console.log('enter to ' + roomName);
	}
 
  // socket: accept connection request
  function onMessage(event) {
		console.log("onMessage(event.type = " + event.type + ")");
    var id = event.from;
		console.log("Message from id = " + id);
    remoteUserName = event.userName;
		var target = event.sendto;
    var conn = getConnection(id);

    if (event.type === 'call') {
      if (! isLocalStreamStarted()) {
        console.log("isLocalStream not started.");
				return;
      }
      if (conn) {
				console.log("already connected.");
        return;  // already connected
      }
 
      if (isConnectPossible()) {
        console.log("send response");
				socket.json.send({type: "response"});
      }
      else {
        console.warn('max connections. so ignore call'); 
      }
      return;
    }
		else if (event.type === 'response') {
			if(localStream) {
				sendOffer(id);
      	console.log("Send offer.");
				return;
			}
			else {
				console.log("localStream does not exist.");
			}
    } else if (event.type === 'offer') {
      console.log("Received offer, set offer, sending answer....")
      onOffer(event);      
    } else if (event.type === 'answer' && isPeerStarted()) {  // **
      console.log('Received answer, settinng answer SDP');
      onAnswer(event);
    } else if (event.type === 'candidate' && isPeerStarted()) { // **
      console.log('Received ICE candidate...');
      onCandidate(event);
    } else if (event.type === 'user disconnected' && isPeerStarted()) { // **
      console.log("disconnected");
      //stop();
      detachVideo(id); // force detach video
			stopConnection(id);
    } else if (event.type === 'bye') {
			detachVideo(id);	
      stopConnection(id);
		}
  }

	function onClosed(id) {
		console.log(id + " disconnected");
		console.log(socketId + " disconnected");
		if(id == socketId) {
			console.log(id + " disconnected");
			detachVideo(id);  
			stopConnection(id);
			return;
		}
		return false;
 	}

  function getRoomName() { // たとえば、 URLに  ?roomName  とする
    var url = document.location.href;
    var args1 = url.split('?');
    if (args1.length > 1) {
      var split_string = args1[1];
			var args2 = split_string.split('&user_name=');
			if (args2.length > 1) {
				room = args2[0];
     		if (room != "") {
        	return room;
      	}
    	}
		}
    return "_defaultroom";
  }

	function getUserName() {
		key = "user_name".replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");  
   	var regex = new RegExp("[\\?&]" + key + "=([^&#]*)");  
   	var qs = regex.exec(window.location.href);  
   	if (qs == null) {  
   		return "名無し";
		}  
   	else {  
   		return qs[1];
		}  
	}
  
  function onOffer(event) {
    console.log("Received offer...")
    console.log(event);
    setOffer(event);
    sendAnswer(event);
    //peerStarted = true; --
  }
  
  function onAnswer(event) {
    console.log("Received Answer...")
    console.log(event);
    setAnswer(event);
  }
  
  function onCandidate(event) {
    var id = event.from;
    var conn = getConnection(id);
    if (! conn) {
      console.error('peerConnection not exist!');
      return;
    }
    
    // --- check if ice ready ---
    if (! conn.iceReady) {
      console.warn("PeerConn is not ICE ready, so ignore");
      return;
    }
      
    var candidate = new RTCIceCandidate({sdpMLineIndex:event.sdpMLineIndex, sdpMid:event.sdpMid, candidate:event.candidate});
    console.log("Received Candidate...")
    console.log(candidate);
    conn.peerconnection.addIceCandidate(candidate);
  }
 
  function sendSDP(sdp) {
    var text = JSON.stringify(sdp);
    console.log("---sending sdp text ---");
    console.log(text);
    socket.json.send(sdp);
  }
  
  function sendCandidate(candidate) {
    var text = JSON.stringify(candidate);
    console.log("---sending candidate text ---");
    // console.log(text);
    socket.json.send(candidate);
  }
  
  // ---------------------- video handling -----------------------
  // start local video
  function startVideo() {
		if(localVideo == null) {
			$('#all_video').append('<div class="ui-grid-c"><div class="ui-block-a" id="user_name_local_video"><div class="ui-bar ui-bar-a"><center><video id="local_video" autoplay style="width: 400px; height: 320px;"></video>' + userName  + '</center></div></div></div>'); 
		localVideo = document.getElementById('local_video');
		}
		navigator.getUserMedia({video: true, audio: false},
    	function (stream) { // success
      	localStream = stream;
      	localVideo.src = window.webkitURL.createObjectURL(stream);
      	localVideo.play();
      	localVideo.volume = 0;
     	},
     	function (error) { // error
      	console.error('An error occurred:');
      	console.error(error);
      	return;
     	}
    );
  }
 
  // stop local video
  function stopVideo() {
    localVideo.src = "";
    localStream.stop();
  }
 
  // ---------------------- connection handling -----------------------
  function prepareNewConnection(id) {
    var pc_config = {"iceServers":[ {"url":"stun:stun.220.110.149.250:3478"}, 
																		{"url":"turn:turn.220.110.149.250:3478", "username":"yourid", "credential":"yourpassword"} ]};
    var peer = null;
    try {
      peer = new webkitRTCPeerConnection(pc_config);
    } catch (e) {
      console.log("Failed to create PeerConnection, exception: " + e.message);
    }
    var conn = new Connection();
    conn.id = id;
    conn.peerconnection = peer;
    peer.id = id;
    console.log("other conn.id = " + conn.id);
		addConnection(id, conn);
 
    // send any ice candidates to the other peer
    peer.onicecandidate = function (event) {
      if (event.candidate) {
        // console.log(event.candidate + id);
        sendCandidate({type: "candidate", 
                          sendto: conn.id,
                          sdpMLineIndex: event.candidate.sdpMLineIndex,
                          sdpMid: event.candidate.sdpMid,
                          candidate: event.candidate.candidate});
      } else {
        console.log("End of candidates. ------------------- phase=" + event.eventPhase);
        conn.established = true;
      }
    };
 
    console.log('Adding local stream...');
    peer.addStream(localStream);
 
    peer.addEventListener("addstream", onRemoteStreamAdded, false);
    peer.addEventListener("removestream", onRemoteStreamRemoved, false)
 
    // when remote adds a stream, hand it on to the local video element
    function onRemoteStreamAdded(event) {
      console.log("Added remote stream");
      attachVideo(this.id, event.stream);
      //remoteVideo.src = window.webkitURL.createObjectURL(event.stream);
    	if(!event.stream) {
				console.log("not exist event.stream!");
			}
		}
 
    // when remote removes a stream, remove it from the local video element
    function onRemoteStreamRemoved(event) {
      console.log("Remove remote stream");
      detachVideo(this.id);
    }
 
    return conn;
  }
 
  function sendOffer(id) {
    var conn = getConnection(id);
    if (!conn) {
      conn = prepareNewConnection(id);
    }
 
    conn.peerconnection.createOffer(function (sessionDescription) { // in case of success
      conn.iceReady = true;
      conn.peerconnection.setLocalDescription(sessionDescription);
      sessionDescription.sendto = id;
      sendSDP(sessionDescription);
    }, function () { // in case of error
      console.log("Create Offer failed");
    }, mediaConstraints);
    conn.iceReady = true;
  }
 
  function setOffer(event) {
    var id = event.from;
    var conn = getConnection(id);
    if (! conn) {
      conn = prepareNewConnection(id);
      conn.peerconnection.setRemoteDescription(new RTCSessionDescription(event));
    }
    else {
      console.error('peerConnection already exist!');
    }
  }
  
  function sendAnswer(event) {
    console.log('sending Answer. Creating remote session description...' );
    var id = event.from;
    console.log("event.from = id = " + id);
		var conn = getConnection(id);
    if (! conn) {
      console.error('peerConnection not exist!');
      return
    }
 
    conn.peerconnection.createAnswer(function (sessionDescription) { 
      // in case of success
      conn.iceReady = true;
      conn.peerconnection.setLocalDescription(sessionDescription);
      sessionDescription.sendto = id;
      sendSDP(sessionDescription);
    }, function () { // in case of error
      console.log("Create Answer failed");
    }, mediaConstraints);
    conn.iceReady = true;
  }
 
  function setAnswer(event) {
    var id = event.from;
    var conn = getConnection(id);
    if (! conn) {
      console.error('peerConnection not exist!');
      return
    }
    conn.peerconnection.setRemoteDescription(new RTCSessionDescription(event));
  }
  
  // call others before connecting peer
  function call() {
    if (! isLocalStreamStarted()) {
      // alert("Local stream not running yet. Please [Start Video] or [Start Screen].");
      alert("ビデオをオンにしてください.");
			return;
    }
    if (! socketReady) {
      // alert("Socket is not connected to server. Please reload and try again.");
      alert("ネットワークにつながっていないか, 調子が悪いのでもう一度再読み込みしてください.");
			return;
    }
 
    // call others, in same room
    console.log("call others in same room, before offer");
    socket.json.send({type: "call"});
	}
  
  // stop the connection upon user request
  function exit() {
    console.log("exit.");
    socket.json.send({type: "bye"});
		socket.emit('exit', roomName);
    detachAllVideo();
    stopAllConnections();
		$(function() {
			$('#video_on').attr('disabled', 'disabled');
			$('#video_off').attr('disabled', 'disabled');
			$('#connect').attr('disabled', 'disabled');
			$('#exit').attr('disabled', 'disabled');
		});
	} 
</script>
</body>
</html>
