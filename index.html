<!DOCTYPE html>
<html lang="ja">
	<head>
		<meta charset="UTF-8">
		<title>webRTC 1 to 1 handshake</title>
	</head>
	<body>
		<button type="button" onclick="startVideo();">Start Video</button>
		<button type="button" onclick="stopVideo();">Stop Video</button>
		
		<button type="button" onclick="connect();">Connect</button>
		<button type="button" onclick="hangUp();">Hang Up</button>
		<br />

		<div>
			<video id="local-video" autoplay style="width: 480px; height: 360px; border: 1px solid black;"></video>
			<video id="remote-video" autoplay style="width: 480px; height: 360px; border: 1px solid black;"></video>
		</div>

		<p>
			SDP to send:<br />
			<textarea id="text-for-send-sdp" rows="5" cols="100" disabled="1">SDP to send</textarea>
		</p>
		<p>
			SDP to receive:<br />
			<textarea id="text-for-receive-sdp" rows="5" cols="100"></textarea><br />
			<button type="button" onclick="onSDP();">Receive SDP</button>
		</p>
		<p>
			ICE Candidate to send:<br />
			<textarea id="text-for-send-ice" rows="5" cols="100" disabled="1">ICE Candidate to send</textarea>
		</p>
		<p>
			ICE Candidates to receive:<br />
			<textarea id="text-for-receive-ice" rows="5" cols="100"></textarea><br />
			<button type="button" onclick="onICE();">Receive ICE Candidates</button>
		</p>

		<script src="/socket.io/socket.io.js></script>
		<script type="text/javascript">
			var localVideo = document.getElementById('local-video');
			var remoteVideo = document.getElementById('remote-video');
			var localStream = null;
			var peerConnection = null;
			var peerStarted = false;
			var mediaConstraints = {'mandatory': {'OfferToReceiveAudio':true, 'OfferToReceiveVideo':true }};

			var socketReady = false;
			var port = process.env.PORT || 9001;
			var socket = io.connect('http://gateside-node.herokuapp.com:' + port + '/');
			socket.on('connect', onOpened).on('message', onMessage);

			function onOpened(evt) {
				console.log('socket opened.');
				socketReady = true;
			}

			function onMessage(evt) {
				if(evt.type === 'offer') {
					console.log("Received offer, set offer, sending answer...");
					onOffer(evt);
				}
				else if(evt.type === 'answer' && peerStarted) {
					console.log('Received answer, setting answer SDP');
					onAnswer(evt);
				}
				else if(evt.type === 'candidate' && peerStarted) {
					console.log('Received ICE candidate...');
					onCandidate(evt);
				}
				else if(evt.type === 'user dissconnected' && peerStarted) {
					console.log("disconnected");
					stop();
				}
			}


			var textForSendSDP = document.getElementById('text-for-send-sdp');
			var textForSendICE = document.getElementById('text-for-send-ice');
			var textToReceiveSDP = document.getElementById('text-for-receive-sdp');
			var textToReceiveICE = document.getElementById('text-for-receive-ice');
			var iceSeparator = '------ ICE Candidate ------';
			var CR = String.fromCharCode(13);

			function onSDP() {
				var text = textToReceiveSDP.value;
				var evt = JSON.parse(text);
				if(peerConnection) {
					onAnswer(evt);
				}
				else {
					onOffer(evt);
				}

				textToReceiveSDP.value = "";
			}

			function onICE() {
				var text = textToReceiveICE.value;
				var arr = text.split(iceSeparator);
				for(var i = 1, len = arr.length; i < len; i++) {
					var evt = JSON.parse(arr[i]);
					onCandidate(evt);
				}

				textToReceiveICE.value = "";
			}

			function onOffer(evt) {
				console.log("Received Offer...");
				console.log(evt);
				setOffer(evt);
				sendAnswer(evt);
				peerStarted = true;
			}

			function onAnswer(evt) {
				console.log("Received Answer...");
				console.log(evt);
				setAnswer(evt);
			}

			function onCandidate(evt) {
				var candidate = new RTCIceCandidate({sdpMLineIndex:evt.sdpMLineInde, sdpMid:evt.sdpMid, candidate:evt.candidate});
				console.log("Received Candidate...");
				console.log(candidate);
				peerConnection.addIceCandidate(candidate);
			}

			function sendSDP(sdp) {
				var text = JSON.stringify(sdp);
				console.log("--- sending sdp text ---");
				console.log(text);

				textForSendSDP.value = text;
				
				socket.json.send(sdp);
			}

			function sendCandidate(candidate) {
				var text = JSON.stringify(candidate);
				console.log("--- sending candidate text ---");
				console.log(text);

				textForSendICE.value = (textForSendICE.value + CR + iceSeparator + CR + text + CR);
				textForSendICE.scrollTop = textForSendICE.scrollHeight;

				socket.json.send(candidate);
			}

			function startVideo() {
				navigator.webkitGetUserMedia({video: true, audio: true}, 
					function(stream) {
						localStream = stream;
						localVideo.src = window.webkitURL.createObjectURL(stream);
						localVideo.play();
						localVideo.volume = 10;
					},
					function(error) {
						console.error('An error occurred: [CODE ' + error.code + ']');
						return;
					}
				);
			}

			function stopVideo() {
				localVideo.src = "";
				localStream.stop();
			}

			function prepareNewConnection() {
				var pc_config = {"iceServers":[]};
				var peer = null;
				try {
					peer = new webkitRTCPeerConnection(pc_config);
				}
				catch(e) {
					console.log("Failed to create peerConnection, exception: " + e.message);
				}

				peer.onicecandidate = function(evt) {
					if(evt.candidate) {
						console.log(evt.candidate);
						sendCandidate({type: "candidate", sdpMLineIndex: evt.candidate.sdpMLineIndex, sdpMid: evt.candidate.sdpMid, candidate: evt.candidate.candidate});
					}
					else {
						console.log("End of candidates. ---------------------- phase=" + evt.eventPhase);
					}
				};

				console.log("Adding local stream...");
				peer.addStream(localStream);

				peer.addEventListener("addstream", onRemoteStreamAdded, false);
				peer.addEventListener("removestream", onRemoteStreamRemoved, false);

				function onRemoteStreamAdded(event) {
					console.log("Added remote stream");
					remoteVideo.src = window.webkitURL.createObjectURL(event.stream);
				}

				function onRemoteStreamRemoved(event) {
					console.log("Removed remote stream");
					remoteVideo.src = "";
				}

				return peer;
			}

			function sendOffer() {
				peerConnection = prepareNewConnection();
				peerConnection.createOffer(function (sessionDescription) {
					peerConnection.setLocalDescription(sessionDescription);
					console.log("Sending: SDP");
					console.log(sessionDescription);
					sendSDP(sessionDescription);
				},
				function() {
					console.log("Create Offer failed");
				}, mediaConstraints);
			}

			function setOffer(evt) {
				if(peerConnection) {
					console.error('peerConnection already exist!');
				}
				peerConnection = prepareNewConnection();
				peerConnection.setRemoteDescription(new RTCSessionDescription(evt));
			}

			function sendAnswer(evt) {
				console.log('sending Answer. Creating remote session description...');
				if(!peerConnection) {
					console.error('peerConnection NOT exist!');
					return;
				}

				peerConnection.createAnswer(function(sessionDescription) {
					peerConnection.setLocalDescription(sessionDescription);
					console.log("Sending: SDP");
					console.log(sessionDescription);
					sendSDP(sessionDescription);
				},
				function() {
					console.log("Create Answer failed");
				}, mediaConstraints);
			}

			function setAnswer(evt) {
				if(!peerConnection) {
					console.error('peerConnection NOT exist!');
					return;
				}
				peerConnection.setRemoteDescription(new RTCSessionDescription(evt));
			}

			function connect() {
				if(!peerStarted && localStream && socketReady) {
					sendOffer();
					peerStarted = true;
				}
				else {
					alert("Local stream not running yet - try again.");
				}
			}

			function hangUp() {
				console.log("Hang up");
				stop();
			}

			function stop() {
				peerConnection.close();
				peerConnection = null;
				peerStarted = false;
			}
		</script>
	</body>
</html>
